#!/usr/bin/env node
var ne=Object.defineProperty;var s=(e,t)=>ne(e,"name",{value:t,configurable:!0});import{Command as re}from"@commander-js/extra-typings";import{randomUUID as P}from"node:crypto";import A from"chalk";import ie from"spinnies";import{access as B,mkdir as M,writeFile as U,appendFile as se,readFile as w}from"node:fs/promises";import j from"yaml";import{glob as T}from"glob";import{resolve as L,dirname as ae}from"node:path";import le from"@anthropic-ai/sdk";import ce from"openai";var p=(e=>(e[e.Stop=0]="Stop",e[e.Length=1]="Length",e[e.FunctionCall=2]="FunctionCall",e[e.Error=3]="Error",e))(p||{});class ue{static{s(this,"Chat")}system;messages=[];tools;setToolSchemas(t){this.tools=t}addSystem(t){this.system=t}addUser(t){this.messages.push({role:"user",content:t})}addAssistant(t,o){this.messages.push({role:"assistant",content:t,toolCalls:o})}addTools(t){this.messages.push({role:"tool",content:t})}toOpenAI(){const t={role:"system",content:this.system},o=this.tools.map(i=>({type:"function",function:i})),r=this.messages.map(i=>{switch(i.role){case"tool":return i.content.map(a=>({role:"tool",tool_call_id:a.id,content:a.content}));case"assistant":return{role:i.role,content:i.content,tool_calls:i.toolCalls.map(a=>({id:a.id,type:"function",function:{name:a.name,arguments:JSON.stringify(a.arguments)}}))};default:return{role:i.role,content:i.content}}}).flat(1/0);return{messages:[t,...r],tools:o}}toAnthropic(){const t=this.messages.map(r=>{switch(r.role){case"assistant":const i=[];return i.push({type:"text",text:r.content}),r.toolCalls&&i.push(...r.toolCalls.map(a=>({type:"tool_use",id:a.id,name:a.name,input:a.arguments}))),{role:"assistant",content:i};case"tool":return{role:"user",content:r.content.map(a=>({type:"tool_result",tool_use_id:a.id,content:a.content}))};default:return{role:"user",content:r.content}}}),o=this.tools.map(r=>({name:r.name,description:r.description,input_schema:r.parameters}));return{system:this.system,messages:t,tools:o}}toString(){return JSON.stringify({system:this.system,messages:this.messages,tools:this.tools})}}function R(e){return Array.isArray(e)?e:[e]}s(R,"arrayify");function v(e){return typeof e=="string"?e:JSON.stringify(e,null,2)}s(v,"stringify");function C(e){return e.slice(0,8)}s(C,"friendly");function fe(e){return new Promise(t=>setTimeout(t,e))}s(fe,"delay");const N="./logs/";class ge{static{s(this,"Writer")}time;constructor(t){this.time=t}get filename(){return`${N}${this.time}.log`}async setup(){try{await B(N)}catch{await M(N)}await U(this.filename,`AXLE: New run at ${this.time}
`)}async write(t){t=`${new Date().toISOString()}> ${t}
`,await se(this.filename,t)}}class pe{static{s(this,"Logger")}instanceId=new Date().toISOString();spinnies=new ie({color:"white",succeedColor:"white"});opts={debug:!1};writer=null;async initWriter(){this.writer=new ge(new Date().toISOString()),await this.writer.setup()}setOptions(t){this.opts={debug:t.debug??!1}}get progress(){return{add:s((t,o)=>{this.spinnies.add(t,{text:o}),this.writer?.write(o)},"add"),update:s((t,o)=>{this.spinnies.update(t,{text:o}),this.writer?.write(o)},"update"),succeed:s((t,o)=>{this.spinnies.succeed(t,{text:o}),this.writer?.write(o)},"succeed"),fail:s((t,o)=>{this.spinnies.fail(t,{text:o}),this.writer?.write(o)},"fail")}}get info(){return{group(t){const o=v(t);console.log(`
${A.blue("==>")} ${A.whiteBright.bold(o)}`),this.writer?.write(o)},log:s(t=>{const o=v(t);console.log(v(t)),this.writer?.write(o)},"log")}}get debug(){const t=this.opts;return{group(o){const r=v(o);t.debug&&console.log(`
${A.gray("==>")} Debug: ${r}`),this.writer?.write(r)},log:s(o=>{const r=v(o);t.debug&&console.log(A.gray(r)),this.writer?.write(r)},"log")}}}const n=new pe;async function q(e,t,o="File"){let r=null,i="";if(e)try{i=L(e),r=await w(i,{encoding:"utf-8"})}catch{throw new Error(`${o} not found, see --help for details`)}else{for(const a of t.formats)try{i=L(t.name+"."+a),r=await w(i,{encoding:"utf-8"});break}catch{continue}if(r===null)throw new Error(`${o} not found, see --help for details`)}return{content:r,format:i.split(".").pop()??""}}s(q,"loadFile");function de(e,t){e=e.replace("**/*","**");const o=/(?<asterisks>\*{1,2})(?<extension>\.[^\\/]+)?/,r=e.match(o);if(r){let i="";return r.groups?.asterisks.length==1?i+=t.fileNameStem:i+=t.directoryPath+t.fileNameStem,r.groups?.extension?i+=r.groups.extension:i+=t.fileExtension,e.replace(r[0],i)}return e}s(de,"replaceFilePattern");function he(e){const t=/(?<name>[^\\/]+)(?<extension>\.[^\\/]+)$/,o=e.match(t);return o&&o.length>0&&o.groups?{absolutePath:e,directoryPath:e.replace(o[0],""),fileExtension:o.groups.extension,fileNameStem:o.groups.name,fullFileName:o[0]}:null}s(he,"pathToComponents");async function ye(e,t="."){try{return(await T(`${t}/${e}.*`)).length>0}catch{return!1}}s(ye,"fileExists");async function V(e){const t=ae(e);try{await B(t)}catch{await M(t),await V(t)}}s(V,"ensureDirectoryExistence");async function me(e,t){await V(e),await U(e,t)}s(me,"writeFileWithDirectories");const be="ax.job",we=["yaml","yml","json"];async function ve(e,t){const{content:o,format:r}=await q(e,{name:be,formats:we},"Job File");let i=null;if(r==="json")i=JSON.parse(o);else if(r==="yaml"||r==="yml")i=j.parse(o);else throw new Error("Invalid job file format");if(n.debug?.group("The Job Object"),n.debug?.log(i),ke(i))return i;throw new Error("The job file is not valid")}s(ve,"getJob");function ke(e){if(n.debug.log("Checking if object is JobConfig"),typeof e!="object")return n.debug.log("JobConfig: Not an object"),!1;if(!Ae(e.using))return n.debug.log("JobConfig: Invalid 'using' property"),!1;if(typeof e.jobs!="object")return n.debug.log("JobConfig: 'jobs' property is not an object"),!1;for(const t in e.jobs)if(!Ce(e.jobs[t]))return n.debug.log(`JobConfig: Invalid job at key '${t}'`),!1;return!0}s(ke,"isJobConfig");function Ae(e){return n.debug.log("Checking if object is Using"),typeof e!="object"?(n.debug.log("Using: Not an object"),!1):typeof e.engine!="string"||e.engine!=="openai"&&e.engine!=="anthropic"?(n.debug.log("Using: Invalid 'engine' property"),!1):e.model!==void 0&&typeof e.model!="string"?(n.debug.log("Using: Invalid 'model' property"),!1):!0}s(Ae,"isUsing");function Ce(e){return n.debug.log("Checking if object is Job"),typeof e!="object"?(n.debug.log("Job: Not an object"),!1):Ie(e)||W(e)?!0:(n.debug.log("Job: Neither AgentJob nor BatchJob"),!1)}s(Ce,"isJob");function Ie(e){if(n.debug.log("Checking if object is AgentJob"),typeof e!="object")return n.debug.log("AgentJob: Not an object"),!1;if(e.type!=="agent")return n.debug.log("AgentJob: Invalid 'type' property"),!1;if(!Array.isArray(e.steps))return n.debug.log("AgentJob: 'steps' is not an array"),!1;for(const t of e.steps)if(!G(t))return n.debug.log("AgentJob: Invalid step in 'steps' array"),!1;return!0}s(Ie,"isAgentJob");function Se(e){return n.debug.log("Checking if object is SkipOptions"),typeof e!="object"?(n.debug.log("SkipOptions: Not an object"),!1):typeof e.folder!="string"?(n.debug.log("SkipOptions: Invalid 'folder' property"),!1):typeof e.contains!="string"?(n.debug.log("SkipOptions: Invalid 'contains' property"),!1):!0}s(Se,"isSkipOptions");function W(e){if(n.debug.log("Checking if object is BatchJob"),typeof e!="object")return n.debug.log("BatchJob: Not an object"),!1;if(e.type!=="batch")return n.debug.log("BatchJob: Invalid 'type' property"),!1;if(!Array.isArray(e.batch))return n.debug.log("BatchJob: 'batch' is not an array"),!1;for(const t of e.batch){if(typeof t!="object")return n.debug.log("BatchJob: Invalid batch item"),!1;if(t.type!=="files")return n.debug.log("BatchJob: Invalid batch item type"),!1;if(typeof t.input!="string")return n.debug.log("BatchJob: Invalid 'input' property in batch item"),!1;if(t["skip-condition"]!==void 0){if(!Array.isArray(t["skip-condition"]))return n.debug.log("BatchJob: 'skip-condition' is not an array"),!1;for(const o of t["skip-condition"])if(!Se(o))return n.debug.log("BatchJob: Invalid skip option in 'skip-condition'"),!1}}if(!Array.isArray(e.steps))return n.debug.log("BatchJob: 'steps' is not an array"),!1;for(const t of e.steps)if(!G(t))return n.debug.log("BatchJob: Invalid step in 'steps' array"),!1;return!0}s(W,"isBatchJob");function G(e){return n.debug.log("Checking if object is Step"),typeof e!="object"?(n.debug.log("Step: Not an object"),!1):J(e)||H(e)||O(e)||K(e)||X(e)?!0:(n.debug.log("Step: Not a valid Step type"),!1)}s(G,"isStep");function J(e){if(n.debug.log("Checking if object is ChatAction"),typeof e!="object")return n.debug.log("ChatAction: Not an object"),!1;if(e.action!=="chat")return n.debug.log("ChatAction: Invalid 'action' property"),!1;if(e.system!==void 0&&typeof e.system!="string")return n.debug.log("ChatAction: Invalid 'system' property"),!1;if(typeof e.content!="string")return n.debug.log("ChatAction: Invalid 'content' property"),!1;if(e.replace!==void 0){if(!Array.isArray(e.replace))return n.debug.log("ChatAction: 'replace' is not an array"),!1;for(const t of e.replace)if(!xe(t))return n.debug.log("ChatAction: Invalid replace in 'replace' array"),!1}return!0}s(J,"isChatAction");function H(e){return n.debug.log("Checking if object is ToolAction"),typeof e!="object"?(n.debug.log("ToolAction: Not an object"),!1):e.action!=="tool-call"?(n.debug.log("ToolAction: Invalid 'action' property"),!1):Array.isArray(e.toolCalls)?!0:(n.debug.log("ToolAction: 'toolCalls' is not an array"),!1)}s(H,"isToolAction");function O(e){return n.debug.log("Checking if object is ToolRespondAction"),typeof e!="object"?(n.debug.log("ToolRespondAction: Not an object"),!1):e.action!=="tool-respond"?(n.debug.log("ToolRespondAction: Invalid 'action' property"),!1):Array.isArray(e.toolCalls)?!0:(n.debug.log("ToolRespondAction: 'toolCalls' is not an array"),!1)}s(O,"isToolRespondAction");function K(e){return n.debug.log("Checking if object is WriteToDiskAction"),typeof e!="object"?(n.debug.log("WriteToDiskAction: Not an object"),!1):e.action!=="write-to-disk"?(n.debug.log("WriteToDiskAction: Invalid 'action' property"),!1):typeof e.output!="string"?(n.debug.log("WriteToDiskAction: Invalid 'output' property"),!1):!0}s(K,"isWriteToDiskAction");function X(e){return n.debug.log("Checking if object is SaveVarAction"),typeof e!="object"?(n.debug.log("SaveVarAction: Not an object"),!1):e.action!=="save-to-variables"?(n.debug.log("SaveVarAction: Invalid 'action' property"),!1):typeof e.name!="string"?(n.debug.log("SaveVarAction: Invalid 'name' property"),!1):!0}s(X,"isSaveVarAction");function xe(e){return n.debug.log("Checking if object is Replace"),typeof e!="object"?(n.debug.log("Replace: Not an object"),!1):Ne(e)||Re(e)||Te(e)?!0:(n.debug.log("Replace: Not a valid Replace type"),!1)}s(xe,"isReplace");function Te(e){return n.debug.log("Checking if object is ReplaceVariables"),typeof e!="object"?(n.debug.log("ReplaceVariables: Not an object"),!1):typeof e.pattern!="string"?(n.debug.log("ReplaceVariables: Invalid 'pattern' property"),!1):e.source!==void 0&&e.source!=="variables"?(n.debug.log("ReplaceVariables: Invalid 'source' property"),!1):typeof e.name!="string"?(n.debug.log("ReplaceVariables: Invalid 'name' property"),!1):!0}s(Te,"isReplaceVariables");function Re(e){return n.debug.log("Checking if object is ReplaceFile"),typeof e!="object"?(n.debug.log("ReplaceFile: Not an object"),!1):typeof e.pattern!="string"?(n.debug.log("ReplaceFile: Invalid 'pattern' property"),!1):e.source!=="file"?(n.debug.log("ReplaceFile: Invalid 'source' property"),!1):typeof e.name!="string"?(n.debug.log("ReplaceFile: Invalid 'name' property"),!1):!0}s(Re,"isReplaceFile");function Ne(e){return n.debug.log("Checking if object is ReplaceManyFiles"),typeof e!="object"?(n.debug.log("ReplaceManyFiles: Not an object"),!1):typeof e.pattern!="string"?(n.debug.log("ReplaceManyFiles: Invalid 'pattern' property"),!1):e.source!=="many-files"?(n.debug.log("ReplaceManyFiles: Invalid 'source' property"),!1):typeof e.name!="string"&&!Array.isArray(e.name)?(n.debug.log("ReplaceManyFiles: Invalid 'name' property"),!1):!0}s(Ne,"isReplaceManyFiles");async function z(e,t){try{const o=await w(t.name,"utf-8");e=e.replace(t.pattern,o)}catch(o){console.error(o)}return e}s(z,"fileReplacer");async function Y(e,t){try{const o=R(t.name);let r="";for(const i of o){const a=await T(i);n.debug.log(`many-files parser. For glob "${i}", found ${a.length} files.`);const c=await Promise.all(a.map(async u=>{const l=await w(u,"utf-8");return u+`:
`+l}));r+=c.join(`
`)}e=e.replace(t.pattern,r)}catch(o){console.error(o)}return e}s(Y,"manyFilesReplacer");function Je(e,t){for(const[o,r]of Object.entries(t))e=e.replace(/\$\{(.*?)\}/g,(i,a)=>t[a]||"");return e}s(Je,"replaceVariables");async function Oe(e){const{step:t,chat:o,provider:r,stats:i,variables:a,options:c}=e;if(J(t)){let{content:g,system:d}=t;t.replace&&([g,d]=await Fe(t.replace,a,t.content,t.system)),d&&o.addSystem(d),o.addUser(g)}else if(O(t)){const d=a.input.map(y=>({id:y.id,content:JSON.stringify(y.results)}));o.addTools(d)}if(c.dryRun)return n.debug.log(o),{action:"continue"};const l=await r.createChatCompletionRequest(o).execute();if(i.in+=l.usage.in,i.out+=l.usage.out,l.type==="success")switch(l.reason){case p.Stop:return l.message.content&&(o.addAssistant(l.message.content),a.input=l.message.content),{action:"continue"};case p.Length:return{action:"error",error:new Error("Incomplete model output due to `max_tokens` parameter or token limit")};case p.FunctionCall:{let g=l.message;return l.message.content&&(o.addAssistant(g.content,g.toolCalls),a.input=l.message.content),{action:"toolCall",toolCalls:g.toolCalls}}}if(n.debug.log(l),l.type==="error")return{action:"error",error:new Error(l.error.message)}}s(Oe,"executeChatAction");async function Fe(e,t,o,r){for(const i of e)switch(i.source){case"file":o=await z(o,i),r&&(r=await z(r,i));break;case"many-files":o=await Y(o,i),r&&(r=await Y(r,i));break;default:o=o.replace(i.pattern,t[i.name]),r&&(r=r.replace(i.pattern,t[i.name]))}return[o,r]}s(Fe,"handleReplace");async function $e(e){const{action:t,variables:o,options:r}=e;if(r.dryRun){n.debug.log("Dry run: no action was taken");return}const i=t.output,a=o.input;if(typeof a=="string"){let c="";i.includes("*")?c=de(i,o.file):c=Je(i,o),await me(c,a)}}s($e,"execWriteToDisk");function _e(e){const{action:t,variables:o,options:r}=e;if(r.dryRun){n.debug.log("Dry run: no action was taken");return}const i=o.input;typeof i=="string"&&(o[t.name]=i)}s(_e,"execSaveToVariables");async function Ee(e){const{step:t,toolManager:o,variables:r}=e,i=t.toolCalls,a=[];for(const u of i)a.push(new Promise((l,g)=>{const d=o.tools[u.name];if(!d){g(`Tool not found: ${u.name}`);return}d(u.arguments).then(y=>l({id:u.id,results:y})).catch(g)}));const c=await Promise.all(a);r.input=c,n.debug.log(c)}s(Ee,"executeToolAction");class De{static{s(this,"DynamicArrayIterator")}array;index=0;constructor(t){this.array=[...t]}*[Symbol.iterator](){for(;this.index<this.array.length;)yield[this.index,this.array[this.index]],this.index++}addItem(t){this.array.splice(this.index+1,0,t)}get length(){return this.array.length}}async function Q(e,t,o,r,i,a){const c=P(),{steps:u}=e;n.progress.add(c,`[${C(c)}] Starting job`);const l=new ue;if(e.tools){const y=o.getSchemas(e.tools);l.setToolSchemas(y)}if(e.variables)for(const[y,f]of Object.entries(e.variables))r[y]=f;let g=!1;const d=new De(u);for(const[y,f]of d)if(n.progress.update(c,`[${C(c)}] Processing step ${y+1}: ${f.action}`),J(f)||O(f)){const{action:m,error:k,toolCalls:b}=await Oe({step:f,chat:l,provider:t,stats:a,variables:r,options:i});k&&(g=!0,console.error(k)),m=="toolCall"&&b&&(d.addItem({action:"tool-respond",toolCalls:b}),d.addItem({action:"tool-call",toolCalls:b}))}else H(f)?await Ee({step:f,toolManager:o,variables:r,options:i}):X(f)?_e({action:f,variables:r,options:i}):K(f)&&await $e({action:f,variables:r,options:i});g?n.progress.fail(c,`[${C(c)}] Failed`):n.progress.succeed(c,`[${C(c)}] completed ${d.length} steps`)}s(Q,"executeAgentCommand");async function Pe(e,t,o,r,i,a){const c=P(),u=[];if(!e.batch)throw new Error("Batch job is missing batch field");const l=R(e.batch);for(const f of l)if(f.type==="files"){const m=f.input,k=await T(m,{withFileTypes:!0});for(const b of k){const E=b.fullpath(),D=he(E);if(!await Be(f["skip-condition"],D)){const oe={variables:{content:await w(E,"utf-8"),file:D},job:e};u.push(oe)}}}if(u.length===0){n.info.log("No runs to execute");return}let g=0;n.progress.add(c,`Working on 0/${u.length}`);const d=s(async f=>{try{await Q(f.job,t,o,{...f.variables,...r},i,a)}catch(m){console.error(m)}finally{g++,n.progress.add(c,`Working on ${g}/${u.length}`)}},"executeRun"),y=5;for(let f=0;f<u.length;f+=y){const m=u.slice(f,f+y);await Promise.all(m.map(d))}n.progress.succeed(c,`All jobs (${u.length}) completed`)}s(Pe,"executeBatchCommand");async function Be(e,t){if(e){let o=R(e);for(const r of o)if(r.folder&&r.contains&&r.contains==="fileNameStem"&&t)return await ye(t.fileNameStem,r.folder)}return!1}s(Be,"processSkipRules");class Me{static{s(this,"AnthropicProvider")}name="Anthropic";client;model;constructor(t,o){this.model=t??"claude-3-5-sonnet-20240620",this.client=new le({apiKey:o.providers.anthropic["api-key"]})}createChatCompletionRequest(t){return new Ue(this.client,this.model,t)}}class Ue{static{s(this,"AnthropicChatRequest")}chat;client;model;constructor(t,o,r){this.client=t,this.model=o,this.chat=r}async execute(){const t={model:this.model,...this.chat.toAnthropic(),max_tokens:je(this.model)};n.debug.log(t);let o;try{const r=await this.client.messages.create(t);o=Le(r)}catch(r){o={type:"error",error:{type:r.error.error.type??"Undetermined",message:r.error.error.message??"Unexpected error from Anthropic"},usage:{in:0,out:0},raw:r}}return n.debug.log(o),o}}function je(e){switch(e){case"claude-3-5-sonnet-20240620":return 4096;case"claude-3-opus-20240229":return 4096;case"claude-3-sonnet-20240229":return 4096;case"claude-3-haiku-20240307":return 4096;default:return 4096}}s(je,"getMaxTokens");function Z(e){switch(e){case"max_tokens":return p.Length;case"end_turn":return p.Stop;case"stop_sequence":return p.Stop;case"tool_use":return p.FunctionCall;default:return p.Error}}s(Z,"getStopReason$1");function Le(e){const t=Z(e.stop_reason);if(t===p.Error)return{type:"error",error:{type:"Uncaught error",message:"Stop reason is not recognized."},usage:{in:e.usage.input_tokens,out:e.usage.output_tokens},raw:e};if(t===p.FunctionCall){const o=e.content[0],r=o.type==="text"?o.text:"",i=e.content.slice(1).map(a=>{if(a.type==="tool_use")return{id:a.id,name:a.name,arguments:a.input}}).filter(a=>a!==null);return{type:"success",id:e.id,model:e.model,reason:p.FunctionCall,message:{role:e.role,content:r,toolCalls:i},usage:{in:e.usage.input_tokens,out:e.usage.output_tokens},raw:e}}if(e.type=="message"){const o=e.content[0];if(o.type=="text")return{type:"success",id:e.id,model:e.model,reason:Z(e.stop_reason),message:{role:e.role,content:o.text},usage:{in:e.usage.input_tokens,out:e.usage.output_tokens},raw:e}}}s(Le,"translate$1");class qe{static{s(this,"OpenAIProvider")}name="OpenAI";client;model;constructor(t,o,r){this.model=t,this.client=new ce({apiKey:o.providers.openai["api-key"]})}createChatCompletionRequest(t){return new Ve(this.client,this.model,t)}}class Ve{static{s(this,"OpenAIRequest")}chat;openai;model;constructor(t,o,r){this.openai=t,this.model=o||"gpt-4o",this.chat=r}async execute(){const t={model:this.model,...this.chat.toOpenAI()};n.debug.log(t);let o;try{const r=await this.openai.chat.completions.create(t);o=Ge(r)}catch(r){console.error(r),o={type:"error",error:{type:r.type??"Undetermined",message:r.message??"Unexpected error from OpenAI"},usage:{in:0,out:0},raw:r}}return n.debug.log(o),o}}function We(e){switch(e){case"length":return p.Length;case"stop":return p.Stop;case"tool_calls":return p.FunctionCall;default:return p.Error}}s(We,"getStopReason");function Ge(e){if(e.choices.length>0){const t=e.choices[0],o=t.message.tool_calls?.map(r=>({id:r.id,name:r.function.name,arguments:JSON.parse(r.function.arguments)}));return{type:"success",id:e.id,model:e.model,reason:We(t.finish_reason),message:{content:t.message.content??"",role:t.message.role,toolCalls:o},usage:{in:e.usage?.prompt_tokens??0,out:e.usage?.completion_tokens??0},raw:e}}return{type:"error",error:{type:"undetermined",message:"Unexpected response from OpenAI"},usage:{in:e.usage?.prompt_tokens??0,out:e.usage?.completion_tokens??0},raw:e}}s(Ge,"translate");function He(e,t,o){return e.engine=="openai"?new qe(e.model,t,o):e.engine=="anthropic"?new Me(e.model,t):null}s(He,"getEngine");const Ke={name:"brave",description:"Perform a search using the Brave search engine",parameters:{type:"object",properties:{searchTerm:{type:"string",description:"The search term to query"}},required:["searchTerm"]}};function Xe(e){if(e["api-key"]){const t=e["api-key"],o=e.delay;return{name:"braveSearch",schema:Ke,fn:ze(t,o)}}return n.debug.log("Brave search API key not found in config"),null}s(Xe,"getBraveSearch");function ze(e,t=void 0){let o=0;return async r=>{const{searchTerm:i}=r;if(n.debug.group(`Brave: searching for ${i}`),t){for(;Date.now()-o<t;)await fe(t-(Date.now()-o));o=Date.now()}try{const a=e,c="https://api.search.brave.com/res/v1/web/search",u=new URL(c);u.searchParams.append("q",i),u.searchParams.append("format","json");const l=await fetch(u.toString(),{method:"GET",headers:{Accept:"application/json","X-Subscription-Token":a}});if(!l.ok)throw new Error(`HTTP error! status: ${l}`);return await l.json()}catch(a){throw console.error("Error fetching search results:",a),a}}}s(ze,"createBraveSearch");function Ye(e,t){const o={},r={},i=Xe(e.tools.brave);return i&&(o.brave=i.fn,r.brave=i.schema),{tools:o,schemas:r,getSchemas:s(c=>{const u=[];for(const l of c)r[l]&&u.push(r[l]);return u},"getSchemas")}}s(Ye,"getTools");const Qe="ax.config",Ze=["yaml","yml","json"];async function et(e,t){const{content:o,format:r}=await q(e,{name:Qe,formats:Ze},"Config File");let i=null;if(r==="json")i=JSON.parse(o);else if(r==="yaml"||r==="yml")i=j.parse(o);else throw new Error("Invalid config file format");if(n.debug.group("The Config Object"),n.debug.log(i),nt(i))return i;throw new Error("The config file is not valid")}s(et,"getConfig");function tt(e){return!e||typeof e!="object"?(n.debug.log("Provider: Not an object"),!1):!("api-key"in e)||typeof e["api-key"]!="string"?(n.debug.log("Provider: Missing or invalid 'api-key'"),!1):"model"in e&&typeof e.model!="string"?(n.debug.log("Provider: Invalid 'model' type"),!1):!0}s(tt,"isProvider");function ee(e){return!e||typeof e!="object"?(n.debug.log("ToolProvider: Not an object"),!1):!("api-key"in e)||typeof e["api-key"]!="string"?(n.debug.log("ToolProvider: Missing or invalid 'api-key'"),!1):!0}s(ee,"isToolProvider");function ot(e){return ee(e)?"delay"in e&&typeof e.delay!="number"?(n.debug.log("BraveProvider: Invalid 'delay' type"),!1):!0:!1}s(ot,"isBraveProvider");function nt(e){if(!e||typeof e!="object")return n.debug.log("Config: Not an object"),!1;if(!("providers"in e)||typeof e.providers!="object")return n.debug.log("Config: Missing or invalid 'providers' property"),!1;if(Object.keys(e.providers).length===0)return n.debug.log("Config: 'providers' object is empty"),!1;if(!("tools"in e)||typeof e.tools!="object")return n.debug.log("Config: Missing or invalid 'tools' property"),!1;for(const[t,o]of Object.entries(e.providers))if(!tt(o))return n.debug.log(`Config: Invalid provider for key '${t}'`),!1;for(const[t,o]of Object.entries(e.tools))if(t==="brave"){if(!ot(o))return n.debug.log("Config: Invalid BraveProvider for key 'brave'"),!1}else if(!ee(o))return n.debug.log(`Config: Invalid ToolProvider for key '${t}'`),!1;return!0}s(nt,"isConfig");const I=new re().name("axle").description("A CLI tool for running AI jobs").version("1.0.0").option("--dry-run","Run the application without executing against the AI providers").option("-c, --config <path>","Path to the config file").option("-j, --job <path>","Path to the job file").option("--no-log","Do not write the output to a log file").option("-d, --debug","Print additional debug information").option("--args <args...>","Additional arguments in the form key=value");I.parse(process.argv);const h=I.opts(),S={};h.args&&h.args.forEach(e=>{const[t,o]=e.split("=");t&&o&&(S[t.trim()]=o.trim())}),n.setOptions(h),h.log&&await n.initWriter(),h.debug&&(n.debug?.group("Options"),n.debug?.log(h),n.debug?.log("Additional Arguments:"),n.debug?.log(S));let F,$;try{F=await et(h.config??null,h),$=await ve(h.job??null,h)}catch(e){n.debug?.log(e.stack),console.error(`${e.stack}`),I.outputHelp(),process.exit(1)}const te=Ye(F),_=He($.using,F,h);_||(console.error("AI Provider is not valid. Please check your job file."),I.outputHelp(),process.exit(1)),n.info.group("All systems operational. Running job...");const rt=Date.now();h.dryRun&&n.info.log("Dry run mode enabled. No API calls will be made.");const x={in:0,out:0};for(const[e,t]of Object.entries($.jobs))n.info.group(`Executing "${e}"`),W(t)?await Pe(t,_,te,S,h,x):await Q(t,_,te,S,h,x);n.info.group("Usage"),n.info.log(`Total run time: ${Date.now()-rt}ms`),n.info.log(`Input tokens: ${x.in} `),n.info.log(`Output tokens: ${x.out} `),n.info.group("Complete. Goodbye");
